---
const { position = "fixed", overlay, offsetTop = false } = Astro.props;
const isOverlay = overlay ?? position === "fixed";
const fixedTopClass = offsetTop ? "top-[var(--logo-bar-height)]" : "top-0";
const positionClass =
  position === "fixed"
    ? `fixed ${fixedTopClass} inset-x-0`
    : position === "sticky"
      ? "sticky top-0"
      : "relative";
const navClass = [
  positionClass,
  "z-50 w-full transition-all duration-300",
  isOverlay
    ? "bg-transparent text-white"
    : "bg-[hsl(255.35deg_91.49%_18.43%)] text-white shadow-sm border-b border-white/10 backdrop-blur",
].join(" ");
const toggleClass = [
  "inline-flex items-center justify-center rounded-md border p-2 transition focus:outline-none focus:ring-2 focus:ring-orange-500/40",
  isOverlay
    ? "text-white border-white/30 bg-white/10 hover:bg-white/20"
    : "text-white border-white/30 bg-white/10 hover:bg-white/20",
].join(" ");
const linkClass =
  "text-base md:text-lg font-medium text-current opacity-90 hover:opacity-100 transition whitespace-nowrap";
const mobileLinkClass =
  "block px-5 py-3 text-base font-medium text-slate-900 hover:bg-slate-50 transition";


const navItems = [
  { href: "/", label: "Home" },
  { href: "/#about", label: "About" },
  { href: "/theme", label: "Themes" },
  { href: "/#faq", label: "FAQ" },
  { href: "/#contact", label: "Contact Us" },
   
  // { href: "/temp", label: "Temp" },
];
---

<nav id="site-nav" class={navClass} data-overlay={isOverlay ? "true" : "false"}>
  <div class="max-w-7xl mx-auto px-6">
    <div class="h-18 flex items-center gap-4 py-2">
        <div class="hidden md:flex flex-1" aria-hidden="true"></div>
        <div class="hidden md:flex flex-1 items-center justify-center gap-8">
          {
            navItems.map((item) => (
              <a href={item.href} class={linkClass} data-nav-link={item.href}>
                {item.label}
              </a>
            ))
          }
        </div>

       <div class="hidden md:flex flex-1 items-center justify-end">
          <!-- <a
            href="/#register"
            class="rounded-md bg-orange-500 px-4 py-2 text-white font-semibold shadow-sm hover:bg-orange-600 transition"
          >
            Register Now
          </a> -->
        </div> 

        <button
          id="nav-toggle"
          class={`ml-auto md:hidden ${toggleClass}`}
          type="button"
          aria-controls="mobile-menu"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <svg
            class="h-5 w-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
    </div>

    <div id="mobile-menu" class="md:hidden hidden pb-4">
      <div
        class="mt-3 rounded-2xl bg-white text-slate-900 shadow-lg ring-1 ring-slate-200/70"
      >
        {
          navItems.map((item, index) => (
            <a
              href={item.href}
              class={`${mobileLinkClass} ${
                index === 0 ? "rounded-t-2xl" : "border-t border-slate-200/70"
              }`}
              data-nav-close
              data-nav-link={item.href}
            >
              {item.label}
            </a>
          ))
        }
        
      </div>
    </div>
  </div>
</nav>

<script>
  const nav = document.getElementById("site-nav");
  const logoBar = document.getElementById("logo-bar");
  const navToggle = document.getElementById("nav-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const iitBadge = document.querySelector(".iitbombay");
  const overlay = nav?.dataset.overlay === "true";
  const logoOverlay = logoBar?.dataset.overlay === "true";
  const root = document.body || document.documentElement;

  const setHeaderVars = () => {
    const logoHeight = logoBar?.offsetHeight ?? 0;
    const navHeight = nav?.offsetHeight ?? 0;
    root.style.setProperty("--logo-bar-height", `${logoHeight}px`);
    root.style.setProperty("--nav-height", `${navHeight}px`);
    root.style.setProperty("--header-height", `${logoHeight + navHeight}px`);
  };
  if ("ResizeObserver" in window) {
    const headerObserver = new ResizeObserver(() => setHeaderVars());
    if (logoBar) headerObserver.observe(logoBar);
    if (nav) headerObserver.observe(nav);
  }

  const closeMenu = () => {
    if (!mobileMenu || !navToggle) return;
    mobileMenu.classList.add("hidden");
    navToggle.setAttribute("aria-expanded", "false");
  };

  const toggleMenu = () => {
    if (!mobileMenu || !navToggle) return;
    const isOpen = !mobileMenu.classList.contains("hidden");
    if (isOpen) {
      closeMenu();
    } else {
      mobileMenu.classList.remove("hidden");
      navToggle.setAttribute("aria-expanded", "true");
    }
  };

  navToggle?.addEventListener("click", toggleMenu);
  document.querySelectorAll("[data-nav-close]").forEach((item) => {
    item.addEventListener("click", closeMenu);
  });
  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768) closeMenu();
    setHeaderVars();
    if (overlay) setNav();
  });

  const navLinks = Array.from(document.querySelectorAll("[data-nav-link]"));
  const linkData = navLinks.map((link) => {
    const href = link.getAttribute("href") || "";
    const url = new URL(href, window.location.origin);
    return { link, path: url.pathname, hash: url.hash };
  });

  const setActiveByKey = (key: string) => {
    linkData.forEach(({ link, path, hash }) => {
      const linkKey = `${path}${hash}`;
      const isActive = linkKey === key;
      link.classList.toggle("font-semibold", isActive);
      link.classList.toggle("opacity-100", isActive);
      link.classList.toggle("text-sky-400", isActive);
    });
  };

  const setActiveLink = () => {
    const currentPath = window.location.pathname;
    const sections = linkData
      .filter(({ path, hash }) => path === currentPath && hash)
      .map(({ hash }) => ({
        hash,
        element: document.querySelector(hash) as HTMLElement | null,
      }))
      .filter(({ element }) => element);

    let activeKey = `${currentPath}${window.location.hash}`;
    if (sections.length) {
      const scrollPosition = window.scrollY + 120;
      activeKey = currentPath;
      sections.forEach(({ hash, element }) => {
        if (element && element.offsetTop <= scrollPosition) {
          activeKey = `${currentPath}${hash}`;
        }
      });
    }
    setActiveByKey(activeKey || currentPath);
  };

  const setToggleTone = (scrolled) => {
    if (!navToggle || !overlay) return;
    if (scrolled) {
      navToggle.classList.add("text-white", "border-white/30", "bg-white/10");
      navToggle.classList.remove(
        "text-slate-700",
        "border-slate-200",
        "bg-white",
      );
    } else {
      navToggle.classList.add("text-white", "border-white/30", "bg-white/10");
      navToggle.classList.remove(
        "text-slate-700",
        "border-slate-200",
        "bg-white",
      );
    }
  };

  const isNarrow = () => window.matchMedia("(max-width: 483px)").matches;
  const setNav = () => {
    if (!nav || !overlay) return;
    const allowLogoOverlay = logoOverlay && !isNarrow();
    const scrolled = window.scrollY > 40;
    if (scrolled) {
      if (allowLogoOverlay) {
        logoBar?.classList.add(
          "bg-white/95",
          "backdrop-blur",
          "border-b",
          "border-slate-200",
          "text-slate-900",
        );
        logoBar?.classList.remove("bg-transparent", "text-white");
      } else if (logoOverlay) {
        logoBar?.classList.add("bg-transparent", "text-white");
        logoBar?.classList.remove(
          "bg-white/95",
          "backdrop-blur",
          "border-b",
          "border-slate-200",
          "text-slate-900",
        );
      }
      nav.classList.add(
        "bg-[hsl(255.35deg_91.49%_18.43%)]",
        "backdrop-blur",
        "shadow-sm",
        "border-b",
        "border-white/10",
        "text-white",
      );
      nav.classList.remove("bg-transparent");
      if (allowLogoOverlay) {
        iitBadge?.classList.add("brightness-0");
        iitBadge?.classList.remove("bg-transparent");
      } else if (logoOverlay) {
        iitBadge?.classList.remove("brightness-0");
      }
    } else {
      if (allowLogoOverlay) {
        logoBar?.classList.add("bg-transparent", "text-white");
        logoBar?.classList.remove(
          "bg-white/95",
          "backdrop-blur",
          "border-b",
          "border-slate-200",
          "text-slate-900",
        );
      } else if (logoOverlay) {
        logoBar?.classList.add("bg-transparent", "text-white");
        logoBar?.classList.remove(
          "bg-white/95",
          "backdrop-blur",
          "border-b",
          "border-slate-200",
          "text-slate-900",
        );
      }
      nav.classList.add("bg-transparent", "text-white");
      nav.classList.remove(
        "bg-[hsl(255.35deg_91.49%_18.43%)]",
        "backdrop-blur",
        "shadow-sm",
        "border-b",
        "border-white/10",
      );
      if (allowLogoOverlay) {
        iitBadge?.classList.add("bg-transparent");
        iitBadge?.classList.remove("brightness-0");
      } else if (logoOverlay) {
        iitBadge?.classList.remove("brightness-0");
      }
    }
    setToggleTone(scrolled);
  };
  if (overlay) {
    window.addEventListener("scroll", setNav, { passive: true });
    setNav();
  }

  window.addEventListener("scroll", setActiveLink, { passive: true });
  window.addEventListener("hashchange", setActiveLink);
  setActiveLink();
  setHeaderVars();
  window.addEventListener("load", setHeaderVars);
</script>
